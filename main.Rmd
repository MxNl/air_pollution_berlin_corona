---
title: "Air Pollution in Berlin during Corona"
author: "Maximilian NÃ¶lscher"
date: "`r format(Sys.Date())`"
output: github_document
---

```{r, include=FALSE}
purrr::map(
  list.files(
    path = "./functions",
    pattern = "\\.R$",
    full.names = TRUE,
    recursive = TRUE
  ),
  source
)
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(fig.width = 10)
```

```{r}
library(sf)
library(lubridate)
library(rvest)
library(tidyverse)
```


# Data Import through Web Scraping

Read website
```{r}
airquality_website <- read_html("https://luftdaten.berlin.de/lqi")
```

Get station information
```{r}
stations <- airquality_website %>%
  html_nodes(".lmn-table__cell--contentAsResponsiveHeadline") %>%
  html_text() %>%
  # tibble(text = .) %>%
  str_remove_all(" ") %>%
  # str_squish() %>%
  str_replace_all("\\n+", "_") %>%
  str_sub(2) %>%
  str_sub(end = -2) %>%
  tibble(station = .) %>%
  separate(col = "station", into = c("station", "type", "description"), sep = "_") %>%
  mutate(station_id = str_sub(station, 1, 3)) %>%
  mutate(station = str_sub(station, 4)) %>%
  select(station_id, everything())
```

Create template url for csv download
```{r}
url_template <- "https://luftdaten.berlin.de/station/mc+++.csv?group=pollution&period=1h&timespan=custom&start%5Bdate%5D=__________&start%5Bhour%5D=00&end%5Bdate%5D=----------&end%5Bhour%5D=00"
```
Replace 

- `+++` by the station id
- `__________` by the start date
- `----------` by the end date

Create station urls
```{r}
download_urls <- stations %>%
  select(station_id) %>%
  mutate(url = url_template) %>%
  mutate(url = str_replace(url, "\\+++", station_id))
```

Define starting dates
```{r}
start_year <- 2004

first_dates <- c(paste0(start_year, "-01-01"), paste0(start_year, "-12-31"))
```

Define a number of years to scrape data for
```{r}
number_of_years <- Sys.Date() %>% year() - start_year + 1
```

Create tables with starting and ending dates, as it is only possible to download data for 1 yeat per request
```{r}
period_starting_dates <- tibble(
  from = seq.Date(as.Date(first_dates[1]),
    by = "year",
    length.out = number_of_years
  )
) %>%
  mutate_all(cus_fun_date_format_to_german)



period_ending_dates <- tibble(
  to = seq.Date(as.Date(first_dates[2]),
    by = "year",
    length.out = number_of_years
  )
) %>%
  mutate_all(cus_fun_date_format_to_german)
```

Make dataframe of urls to fetch
```{r}
urls_to_fetch <- map2_dfr(period_starting_dates,
                          period_ending_dates,
                          .f = ~ cus_fun_fill_dates_in_url(pull(filter(download_urls, station_id == 115), url), 
                                                           .x, 
                                                           .y)
)
```



Download the data for all the defined years at one station
```{r}
download <- urls_to_fetch %>% 
  pull(from) %>% 
  map(cus_fun_read_csv_from_url)
```

Remove header rows
```{r}
station_data <- download %>% 
  map(~slice(., -c(2:3))) %>% 
  map(~set_names(., as_vector(slice(., 1)))) %>% 
  map(~slice(., -1))
```

Determine all columns that are common to all years
```{r}
columns_to_keep <- station_data %>% 
  map(~names(.)) %>% 
  Reduce(intersect, .)
```

Fix column names
```{r}
station_data <- station_data %>% 
  map_dfr(~select(., one_of(columns_to_keep))) %>% 
  rename("date" = 1) %>% 
  janitor::clean_names()
```

Fix date column
```{r}
station_data <- station_data %>% 
  mutate(date = dmy_hm(date))
```

Remove possible duplicates
```{r}
station_data <- station_data %>%
  distinct(date, .keep_all = TRUE)
```

Fix column data types
```{r}
station_data <- station_data %>% 
  mutate_if(is.character, as.numeric)
```

Define parameters
```{r}
variables <- c("stickstoffmonoxid", "stickstoffdioxid", "stickoxide")
```

Select those parameters
```{r}
station_data <- station_data %>% 
  select(date, one_of(variables))
```

Add columns for year, month, ...
```{r}
station_data <- station_data %>%
  mutate(year = year(date)) %>%
  mutate(month = month(date)) %>%
  mutate(week = week(date)) %>%
  mutate(day = day(date)) %>%
  mutate(weekday = weekdays(date)) %>%
  mutate(daytime = hour(date)) %>%
  mutate(yearday = yday(date)) %>%
  select(date, year, month, week, day, weekday, daytime, yearday, everything())
```

Show the dataframe
```{r}
station_data
```

```{r}
station_data <- station_data %>% 
  janitor::remove_empty(c("cols", "rows"))
```


# First visualizations

Clean outliers
```{r}
station_data <- station_data %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name) %>%
  mutate(value = ifelse(value >= 1e4, NA, value)) %>%
  mutate(value = zoo::na.approx(value, na.rm = FALSE)) %>%
  pivot_wider()
```


```{r}
station_data %>%
  pivot_longer(cols = one_of(variables)) %>%
  ggplot(aes(date, value, group = name)) +
  geom_line(
    colour = "red",
    alpha = .6
  ) +
  scale_x_datetime(
    date_breaks = "1 year",
    # date_minor_breaks = "1 month",
    date_labels = "%b\n'%y"
  ) +
  facet_wrap(~name, ncol = 1, scales = "free_y")
```

Filter out years before the data gab
```{r}
station_data <- station_data %>% 
  filter(year >= 2002)
```


Weekly mean concentration
```{r}
station_data %>%
  select(-stickoxide) %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name, week) %>%
  summarise(mean = mean(value, na.rm = TRUE)) %>%
  ggplot(aes(week, mean, group = name, fill = mean)) +
  geom_col(alpha = .6) +
  # scale_x_datetime(date_breaks = "month") +
  scale_fill_gradient(low = "darkgreen", high = "red") +
  scale_x_continuous(breaks = seq(0, 52, 5)) +
  facet_wrap(~name, ncol = 1, scales = "free_y")
```


Daily values compared to period mean
```{r}
station_data %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name) %>%
  mutate(mean = mean(value, na.rm = TRUE)) %>%
  group_by(name) %>%
  mutate(diff_to_mean = value - mean) %>%
  group_by(name, year, month, day) %>%
  summarise(daily_mean_diff_to_mean = mean(diff_to_mean, na.rm = TRUE)) %>%
  mutate(
    date = as_date(str_c(year, month, day, sep = "-")),
    colour_category = if_else(daily_mean_diff_to_mean <= 0, "negativ", "positiv")
  ) %>%
  ggplot(aes(date,
    daily_mean_diff_to_mean,
    group = name,
    fill = daily_mean_diff_to_mean
  )) +
  geom_col() +
  # scale_fill_manual() +
  scale_fill_gradient2(low = "darkgreen", mid = "snow3", high = "red") +
  scale_x_date(
    date_breaks = "1 year",
    date_minor_breaks = "1 month",
    date_labels = "%b\n'%y"
  ) +
  theme(legend.position = "none") +
  facet_wrap(~name, ncol = 1, scales = "free_y")
```

Mean daily values compared to period mean
```{r}
station_data %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name) %>%
  mutate(mean = mean(value, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(name) %>%
  mutate(diff_to_mean = value - mean) %>%
  ungroup() %>%
  group_by(name, year, month, day) %>%
  summarise(daily_mean_diff_to_mean = mean(diff_to_mean, na.rm = TRUE)) %>%
  mutate(
    date = as_date(str_c(year, month, day, sep = "-")),
    colour_category = if_else(daily_mean_diff_to_mean <= 0, "negative", "positive")
  ) %>%
  ggplot(aes(
    date,
    daily_mean_diff_to_mean
  )) +
  geom_area(
    fill = "red",
    alpha = .3
  ) +
  geom_ribbon(aes(ymin = 0, ymax = ifelse(daily_mean_diff_to_mean >= 0, 0, daily_mean_diff_to_mean)),
    fill = "green",
    alpha = .3
  ) +
  # scale_fill_manual() +
  # scale_fill_gradient2(low='darkgreen', mid='snow3', high='red') +
  scale_x_date(
    date_breaks = "3 month",
    date_minor_breaks = "1 month",
    date_labels = "%b\n'%y"
  ) +
  theme(legend.position = "none") +
  facet_wrap(~name, ncol = 1, scales = "free_y")
```

```{r}
days_in_week <- tibble(
  weekday = weekdays(x = as.Date(seq(7), origin = "1950-01-01")),
  weekday_id = 1:7
)
```

```{r}
days_in_week_vec <- days_in_week %>% pull(weekday_id)

names(days_in_week_vec) <- days_in_week %>% pull(weekday)
```

Mean concentrations per weekday
```{r}
station_data %>%
  select(-stickoxide) %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name, weekday) %>%
  summarise(mean_weekday = mean(value, na.rm = TRUE)) %>%
  group_by(name) %>%
  left_join(days_in_week) %>%
  arrange(weekday_id) %>%
  ggplot(aes(weekday_id, mean_weekday, fill = mean_weekday, group = name)) +
  geom_col(alpha = .5) +
  theme(legend.position = "none") +
  scale_x_continuous(
    breaks = 1:7,
    labels = pull(days_in_week, weekday)
  ) +
  scale_fill_gradient(low = "darkgreen", high = "red") +
  facet_wrap(~name, ncol = 1)
```

Mean concentrations per per hour per weekday
```{r}
station_data %>%
  select(-stickoxide) %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name, weekday, daytime) %>%
  summarise(mean_weekday_daytime = mean(value, na.rm = TRUE)) %>%
  group_by(name) %>%
  left_join(days_in_week, by = "weekday") %>%
  arrange(weekday_id, daytime) %>%
  ggplot(aes(daytime, mean_weekday_daytime, fill = mean_weekday_daytime, group = name)) +
  geom_col(alpha = .5) +
  theme(legend.position = "none") +
  scale_fill_gradient(low = "darkgreen", high = "red") +
  facet_grid(weekday_id ~ name, scales = "free_y")
```

Concentrations over the day on weekdays over time
```{r}
station_data %>%
  select(-stickoxide) %>%
  pivot_longer(cols = one_of(variables)) %>%
  left_join(days_in_week, by = "weekday") %>% 
  filter(weekday_id <= 5) %>% 
  group_by(name, year, daytime) %>% 
  summarise(mean_year_weekday_daytime = mean(value, na.rm = TRUE)) %>%
  # left_join(days_in_week, by = "weekday") %>%
  # arrange(weekday_id, daytime) %>%
  # group_by(name) %>%
  # arrange(weekday_id, daytime) %>%
  ggplot(aes(daytime, year, fill = mean_year_weekday_daytime, group = name)) +
  geom_tile() +
  theme(legend.position = "none") +
  scale_fill_viridis_c() +
  scale_y_reverse() +
  facet_wrap(~ name)
```

Concentrations over the day on weekends over time
```{r}
station_data %>%
  select(-stickoxide) %>%
  pivot_longer(cols = one_of(variables)) %>%
  left_join(days_in_week, by = "weekday") %>% 
  filter(weekday_id > 5) %>% 
  group_by(name, year, daytime) %>% 
  summarise(mean_year_weekday_daytime = mean(value, na.rm = TRUE)) %>%
  # left_join(days_in_week, by = "weekday") %>%
  # arrange(weekday_id, daytime) %>%
  # group_by(name) %>%
  # arrange(weekday_id, daytime) %>%
  ggplot(aes(daytime, year, fill = mean_year_weekday_daytime, group = name)) +
  geom_tile() +
  theme(legend.position = "none") +
  scale_fill_viridis_c() +
  scale_y_reverse() +
  facet_wrap(~ name)
```

Mean concentrations per per hour per weekday
```{r}
station_data %>%
  select(-stickoxide) %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name, weekday, daytime) %>%
  summarise(mean_weekday_daytime = mean(value, na.rm = TRUE)) %>%
  group_by(name) %>%
  left_join(days_in_week, by = "weekday") %>%
  arrange(weekday_id, daytime) %>%
  ggplot(aes(daytime, weekday_id, fill = mean_weekday_daytime, group = name)) +
  geom_tile(alpha = .5) +
  theme(legend.position = "none") +
  scale_fill_gradient(low = "darkgreen", high = "red") +
  scale_y_reverse(
    breaks = 1:7,
    labels = pull(days_in_week, weekday)
  ) +
  facet_wrap(~name, ncol = 3, scales = "free_y")
```


```{r}
station_data %>%
  select(-stickstoffdioxid, -stickstoffmonoxid) %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name, year, week) %>%
  summarise(mean_year_day = mean(value, na.rm = TRUE)) %>%
  ggplot(aes(week, year, group = name, fill = mean_year_day)) +
  geom_tile() +
  # scale_x_datetime(date_breaks = "month") +
  # scale_fill_gradient(low = 'darkgreen', high = 'red') +
  scale_fill_viridis_c() +
  scale_x_continuous(breaks = seq(0, 52, 5)) +
  scale_y_reverse(breaks = unique(pull(station_data, year)))
```


```{r}
station_data %>%
  select(-stickstoffdioxid, -stickstoffmonoxid) %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name, year, yearday) %>%
  summarise(mean_year_yearday = mean(value, na.rm = TRUE)) %>%
  ggplot(aes(yearday, year, group = name, fill = mean_year_yearday)) +
  geom_tile() +
  # scale_x_datetime(date_breaks = "month") +
  # scale_fill_gradient(low = 'darkgreen', high = 'red') +
  scale_fill_viridis_c() +
  scale_x_continuous(
    breaks = seq(0, 365, 10),
    guide = guide_axis(n.dodge = 2)
  ) +
  scale_y_reverse(breaks = unique(pull(station_data, year))) +
  labs(fill = "mean")
```

Compare this years week 12 and 13 to those from the past
```{r}
station_data %>%
  select(-stickoxide) %>%
  filter(week %in% c(12, 13)) %>%
  pivot_longer(cols = one_of(variables)) %>%
  group_by(name, year) %>%
  summarise(mean_year_kw1213 = mean(value, na.rm = TRUE)) %>%
  ggplot(aes(year, mean_year_kw1213)) +
  geom_col(aes(fill = mean_year_kw1213)) +
  scale_x_continuous(labels = as.integer) +
  scale_fill_gradient(low = "darkgreen", high = "red") +
  facet_wrap(~name, ncol = 1)
```

